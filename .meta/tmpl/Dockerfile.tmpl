{{ $usesGolang := hasPrefix .config.image "golang" -}}
{{ $golang := index .config.tools "golang/go" -}}
{{ $golangci_lint := index .config.tools "golangci/golangci-lint" -}}

{{ $terraform := index .config.tools "hashicorp/terraform" -}}
{{ $terragrunt := index .config.tools "gruntwork-io/terragrunt" -}}
{{ $tflint := index .config.tools "terraform-linters/tflint" -}}
{{ $tflint_aws := index .config.tools "terraform-linters/tflint-ruleset-aws" -}}
{{ $tfsec := index .config.tools "aquasecurity/tfsec" -}}
{{ $terraform_docs := index .config.tools "terraform-docs/terraform-docs" -}}
{{ $terrascan := index .config.tools "accurics/terrascan" -}}
{{ $just := index .config.tools "casey/just" -}}
{{ $direnv := index .config.tools "direnv/direnv" -}}
{{ $op := index .config.tools "1password" -}}
{{ $kubectl := index .config.tools "kubernetes/kubectl" -}}
{{ $sops := index .config.tools "mozilla/sops" -}}
{{ $drone := index .config.tools "harness/drone-cli" -}}
{{ $kubectx := index .config.tools "ahmetb/kubectx" -}}
{{ $starship := index .config.tools "starship/starship" -}}
{{ $hadolint := index .config.tools "hadolint/hadolint" -}}

FROM {{ tpl "image" .config.image (dict "version" $golang) }} as core
# hadolint ignore=DL3018
RUN apk add --update --no-cache \
    bash curl git openssh openssh-client jq graphviz ncurses nano libc6-compat bash-completion {{ join .config.extraPackages " " }}

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ENV EDITOR nano

FROM core as terraform
RUN curl -L https://releases.hashicorp.com/terraform/{{ $terraform }}/terraform_{{ $terraform }}_linux_amd64.zip -o /tmp/terraform.zip \
    && unzip /tmp/terraform.zip -d /tmp/ && rm /tmp/terraform.zip

FROM core as terragrunt
RUN curl -L https://github.com/gruntwork-io/terragrunt/releases/download/v{{ $terragrunt }}/terragrunt_linux_amd64 -o /tmp/terragrunt \
    && chmod +x /tmp/terragrunt

FROM core as tflint
RUN curl -L https://github.com/terraform-linters/tflint/releases/download/v{{ $tflint }}/tflint_linux_amd64.zip -o /tmp/tflint.zip \
    && unzip /tmp/tflint.zip -d /tmp/ && rm /tmp/tflint.zip

FROM core as tflint_aws
RUN curl -L https://github.com/terraform-linters/tflint-ruleset-aws/releases/download/v{{ $tflint_aws }}/tflint-ruleset-aws_linux_amd64.zip  -o /tmp/tflint-ruleset-aws.zip \
    && unzip /tmp/tflint-ruleset-aws.zip -d /tmp/ && rm /tmp/tflint-ruleset-aws.zip

FROM core as tfsec
RUN curl -L https://github.com/aquasecurity/tfsec/releases/download/v{{ $tfsec }}/tfsec-linux-amd64 -o /tmp/tfsec \
    && chmod +x /tmp/tfsec

FROM core as terraform_docs
RUN curl -L https://github.com/terraform-docs/terraform-docs/releases/download/v{{ $terraform_docs }}/terraform-docs-v{{ $terraform_docs }}-linux-amd64 -o /tmp/terraform-docs \
    && chmod +x /tmp/terraform-docs

FROM core as terrascan
# hadolint ignore=DL3003
RUN curl -L https://github.com/accurics/terrascan/releases/download/v{{ $terrascan }}/terrascan_{{ $terrascan }}_Linux_x86_64.tar.gz -o /tmp/terrascan.tar.gz \
    && cd /tmp && tar -xf /tmp/terrascan.tar.gz terrascan && rm /tmp/terrascan.tar.gz

FROM core as just
# hadolint ignore=DL4006
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /tmp/ --tag {{ $just }}

FROM core as direnv
RUN curl -L https://github.com/direnv/direnv/releases/download/v{{ $direnv }}/direnv.linux-amd64 -o /tmp/direnv \
    && chmod +x /tmp/direnv

FROM core as hadolint
RUN curl -L https://github.com/hadolint/hadolint/releases/download/v{{ $hadolint }}/hadolint-Linux-x86_64 -o /tmp/hadolint \
    && chmod +x /tmp/hadolint

FROM core as op
RUN curl -L https://cache.agilebits.com/dist/1P/op/pkg/v{{ $op }}/op_linux_amd64_v{{ $op }}.zip -o /tmp/op.zip \
    && unzip /tmp/op.zip -d /tmp/ && rm /tmp/op.zip

FROM core as kubectl
RUN curl -L https://storage.googleapis.com/kubernetes-release/release/v{{ $kubectl }}/bin/linux/amd64/kubectl -o /tmp/kubectl \
    && chmod +x /tmp/kubectl

FROM core as kubectx
# hadolint ignore=DL4006
RUN curl -L https://github.com/ahmetb/kubectx/releases/download/v{{ $kubectx }}/kubectx_v{{ $kubectx }}_linux_x86_64.tar.gz | tar zx \
    && cp kubectx /tmp && chmod +x /tmp/kubectx \
    && curl -L https://github.com/ahmetb/kubectx/releases/download/v{{ $kubectx }}/kubens_v{{ $kubectx }}_linux_x86_64.tar.gz | tar zx \
    && cp kubens /tmp && chmod +x /tmp/kubens

FROM core as drone
# hadolint ignore=DL4006
RUN curl -L https://github.com/harness/drone-cli/releases/download/v{{ $drone }}/drone_linux_amd64.tar.gz | tar zx \
    && cp drone /tmp && chmod +x /tmp/drone

FROM core as sops
RUN curl -L https://github.com/mozilla/sops/releases/download/v{{ $sops }}/sops-v{{ $sops }}.linux -o /tmp/sops \
    && chmod +x /tmp/sops

{{ if $usesGolang }}
FROM core as golangci_lint
# hadolint ignore=DL4006
RUN curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/v{{ $golangci_lint }}/install.sh | sh -s -- -b /tmp v{{ $golangci_lint }}
{{- end }}

FROM core

# hadolint ignore=DL3018,DL3013,DL3042
RUN apk add --no-cache \
        python3 \
        py3-pip \
        groff \
    && pip3 install --upgrade pip \
    && pip3 install --no-cache-dir \
        awscli \
    && rm -rf /var/cache/apk/*

# hadolint ignore=DL4006
RUN sh -c "$(curl -fsSL https://starship.rs/install.sh | sed 's|latest/download|download/v{{ $starship }}|g')" -- -y

COPY --from=terraform /tmp/terraform /usr/local/bin/terraform
COPY --from=terragrunt /tmp/terragrunt /usr/local/bin/terragrunt
COPY --from=tflint /tmp/tflint /usr/local/bin/tflint
COPY --from=tflint_aws /tmp/tflint-ruleset-aws $TFLINT_PLUGIN_DIR/tflint-ruleset-aws
COPY --from=tfsec /tmp/tfsec /usr/local/bin/tfsec
COPY --from=terraform_docs /tmp/terraform-docs /usr/local/bin/terraform-docs
COPY --from=terrascan /tmp/terrascan /usr/local/bin/terrascan
COPY --from=just /tmp/just /usr/local/bin/just
COPY --from=direnv /tmp/direnv /usr/local/bin/direnv
COPY --from=op /tmp/op /usr/local/bin/op
COPY --from=kubectl /tmp/kubectl /usr/local/bin/kubectl
COPY --from=sops /tmp/sops /usr/local/bin/sops
COPY --from=drone /tmp/drone /usr/local/bin/drone
COPY --from=kubectx /tmp/kubectx /usr/local/bin/kctx
COPY --from=kubectx /tmp/kubens /usr/local/bin/kns
COPY --from=hadolint /tmp/hadolint /usr/local/bin/hadolint

ENV GH_VERSIONS='{ \
  {{- if $usesGolang }}
  "golangci/golangci-lint":"v{{ $golangci_lint }}", \
  {{- end }}
  "hashicorp/terraform":"v{{ $terraform }}", \
  "gruntwork-io/terragrunt":"v{{ $terragrunt }}", \
  "terraform-linters/tflint":"v{{ $tflint }}", \
  "terraform-linters/tflint-ruleset-aws":"v{{ $tflint_aws }}", \
  "aquasecurity/tfsec":"v{{ $tfsec }}", \
  "terraform-docs/terraform-docs":"v{{ $terraform_docs }}", \
  "accurics/terrascan":"v{{ $terrascan }}", \
  "ahmetb/kubectx":"v{{ $kubectx }}", \
  "casey/just":"{{ $just }}", \
  "direnv/direnv":"v{{ $direnv }}", \
  "starship/starship":"v{{ $starship }}", \
  "mozilla/sops":"v{{ $sops }}", \
  "harness/drone-cli":"v{{ $drone }}", \
  "hadolint/hadolint":"v{{ $hadolint }}" \
}'

RUN adduser -h /home/user -s /bin/bash -u 1000 -D user

RUN mkdir /etc/bash_completion.d \
    && kubectl completion bash > /etc/bash_completion.d/kubectl \
    && curl -L "https://raw.githubusercontent.com/ahmetb/kubectx/v{{ $kubectx }}/completion/kubectx.bash" -o /etc/bash_completion.d/kubectx \
    && curl -L "https://raw.githubusercontent.com/ahmetb/kubectx/v{{ $kubectx }}/completion/kubens.bash" -o /etc/bash_completion.d/kubens

# hadolint ignore=SC2016
RUN { \
      echo 'eval "$(direnv hook bash)"'; \
      echo 'eval $(ssh-agent);' 'ssh-add'; \
      echo 'eval "$(starship init bash)"'; \
      echo 'source /etc/profile.d/bash_completion.sh'; \
    } > /home/user/.bashrc

{{- if $usesGolang }}
ENV CGO_ENABLED=0
{{- end }}
ENV PATH="/terraform/.meta/bin:${PATH}"
ENV DIRENV_CONFIG="/terraform/.meta/direnv"
ENV STARSHIP_CONFIG="/terraform/.meta/starship/config.toml"

ENTRYPOINT []
