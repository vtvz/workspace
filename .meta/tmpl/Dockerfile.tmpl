{{ $usesGolang := hasPrefix .config.image "golang" -}}
{{ $golang := index .config.tools "golang/go" -}}

{{ $github := .config.tools.github -}}
{{ $golangci_lint := index $github "golangci/golangci-lint" -}}
{{ $terraform := index $github "hashicorp/terraform" -}}
{{ $terragrunt := index $github "gruntwork-io/terragrunt" -}}
{{ $tflint := index $github "terraform-linters/tflint" -}}
{{ $tflint_aws := index $github "terraform-linters/tflint-ruleset-aws" -}}
{{ $tfsec := index $github "aquasecurity/tfsec" -}}
{{ $terraform_docs := index $github "terraform-docs/terraform-docs" -}}
{{ $terrascan := index $github "accurics/terrascan" -}}
{{ $hadolint := index $github "hadolint/hadolint" -}}
{{ $kubectx := index $github "ahmetb/kubectx" -}}
{{ $just := index $github "casey/just" -}}
{{ $direnv := index $github "direnv/direnv" -}}
{{ $starship := index $github "starship/starship" -}}
{{ $sops := index $github "mozilla/sops" -}}
{{ $drone := index $github "harness/drone-cli" -}}

{{ $op := index .config.tools "1password" -}}
{{ $kubectl := index .config.tools "kubernetes/kubectl" -}}
{{ $awscli := index .config.tools "awscli" -}}

FROM {{ tpl "image" .config.image (dict "version" $golang) }} as core
# hadolint ignore=DL3008
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
      bash curl git openssh-client jq graphviz nano bash-completion groff unzip \
    && rm -rf /var/lib/apt/lists/*

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

ENV EDITOR nano

FROM core as terraform
RUN curl -fL https://releases.hashicorp.com/terraform/{{ $terraform }}/terraform_{{ $terraform }}_linux_amd64.zip -o /tmp/terraform.zip \
    && unzip /tmp/terraform.zip -d /tmp/ && rm /tmp/terraform.zip

FROM core as terragrunt
RUN curl -fL https://github.com/gruntwork-io/terragrunt/releases/download/v{{ $terragrunt }}/terragrunt_linux_amd64 -o /tmp/terragrunt \
    && chmod +x /tmp/terragrunt

FROM core as tflint
RUN curl -fL https://github.com/terraform-linters/tflint/releases/download/v{{ $tflint }}/tflint_linux_amd64.zip -o /tmp/tflint.zip \
    && unzip /tmp/tflint.zip -d /tmp/ && rm /tmp/tflint.zip

FROM core as tflint_aws
RUN curl -fL https://github.com/terraform-linters/tflint-ruleset-aws/releases/download/v{{ $tflint_aws }}/tflint-ruleset-aws_linux_amd64.zip  -o /tmp/tflint-ruleset-aws.zip \
    && unzip /tmp/tflint-ruleset-aws.zip -d /tmp/ && rm /tmp/tflint-ruleset-aws.zip

FROM core as tfsec
RUN curl -fL https://github.com/aquasecurity/tfsec/releases/download/v{{ $tfsec }}/tfsec-linux-amd64 -o /tmp/tfsec \
    && chmod +x /tmp/tfsec

FROM core as terraform_docs
# hadolint ignore=DL3003
RUN curl -fL https://github.com/terraform-docs/terraform-docs/releases/download/v{{ $terraform_docs }}/terraform-docs-v{{ $terraform_docs }}-linux-amd64.tar.gz -o /tmp/terraform-docs.tar.gz \
    && cd /tmp && tar -xf /tmp/terraform-docs.tar.gz terraform-docs && rm /tmp/terraform-docs.tar.gz

FROM core as terrascan
# hadolint ignore=DL3003
RUN curl -fL https://github.com/accurics/terrascan/releases/download/v{{ $terrascan }}/terrascan_{{ $terrascan }}_Linux_x86_64.tar.gz -o /tmp/terrascan.tar.gz \
    && cd /tmp && tar -xf /tmp/terrascan.tar.gz terrascan && rm /tmp/terrascan.tar.gz

FROM core as just
# hadolint ignore=DL4006
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /tmp/ --tag {{ $just }}

FROM core as direnv
RUN curl -fL https://github.com/direnv/direnv/releases/download/v{{ $direnv }}/direnv.linux-amd64 -o /tmp/direnv \
    && chmod +x /tmp/direnv

FROM core as hadolint
RUN curl -fL https://github.com/hadolint/hadolint/releases/download/v{{ $hadolint }}/hadolint-Linux-x86_64 -o /tmp/hadolint \
    && chmod +x /tmp/hadolint

FROM core as op
RUN curl -fL https://cache.agilebits.com/dist/1P/op/pkg/v{{ $op }}/op_linux_amd64_v{{ $op }}.zip -o /tmp/op.zip \
    && unzip /tmp/op.zip -d /tmp/ && rm /tmp/op.zip

FROM core as kubectl
RUN curl -fL https://storage.googleapis.com/kubernetes-release/release/v{{ $kubectl }}/bin/linux/amd64/kubectl -o /tmp/kubectl \
    && chmod +x /tmp/kubectl

FROM core as kubectx
# hadolint ignore=DL4006
RUN curl -fL https://github.com/ahmetb/kubectx/releases/download/v{{ $kubectx }}/kubectx_v{{ $kubectx }}_linux_x86_64.tar.gz | tar zx \
    && cp kubectx /tmp && chmod +x /tmp/kubectx

FROM core as kubens
# hadolint ignore=DL4006
RUN curl -fL https://github.com/ahmetb/kubectx/releases/download/v{{ $kubectx }}/kubens_v{{ $kubectx }}_linux_x86_64.tar.gz | tar zx \
    && cp kubens /tmp && chmod +x /tmp/kubens

FROM core as drone
# hadolint ignore=DL4006
RUN curl -fL https://github.com/harness/drone-cli/releases/download/v{{ $drone }}/drone_linux_amd64.tar.gz | tar zx \
    && cp drone /tmp && chmod +x /tmp/drone

FROM core as sops
RUN curl -fL https://github.com/mozilla/sops/releases/download/v{{ $sops }}/sops-v{{ $sops }}.linux -o /tmp/sops \
    && chmod +x /tmp/sops

{{ if $usesGolang }}
FROM core as golangci_lint
# hadolint ignore=DL4006
RUN curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/v{{ $golangci_lint }}/install.sh | sh -s -- -b /tmp v{{ $golangci_lint }}
{{- end }}

FROM core

# hadolint ignore=DL3008
RUN apt-get update \
    && apt-get install --no-install-recommends -y \
      python3 python3-pip {{ join .config.extraPackages " " }} \
    && rm -rf /var/lib/apt/lists/*

# hadolint ignore=DL3003,DL4006
RUN tmp="$(mktemp -d)" \
  && cd "$tmp" \
  && curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-{{ $awscli }}.zip" -o "awscliv2.zip" \
  && unzip awscliv2.zip \
  && ./aws/install \
  && rm -rf "$tmp"

ENV AWS_CLI_VERSION="{{ $awscli }}"

RUN pip3 install --no-cache-dir \
    {{ range $p, $v := .config.tools.pip -}}
        {{ $p }}=={{ $v }} \
    {{ end }};

# hadolint ignore=DL4006
RUN sh -c "$(curl -fsSL https://starship.rs/install.sh | sed 's|latest/download|download/v{{ $starship }}|g')" -- -y

COPY --from=terraform /tmp/terraform /usr/local/bin/terraform
COPY --from=terragrunt /tmp/terragrunt /usr/local/bin/terragrunt
COPY --from=tflint /tmp/tflint /usr/local/bin/tflint
COPY --from=tflint_aws /tmp/tflint-ruleset-aws $TFLINT_PLUGIN_DIR/tflint-ruleset-aws
COPY --from=tfsec /tmp/tfsec /usr/local/bin/tfsec
COPY --from=terraform_docs /tmp/terraform-docs /usr/local/bin/terraform-docs
COPY --from=terrascan /tmp/terrascan /usr/local/bin/terrascan
COPY --from=just /tmp/just /usr/local/bin/just
COPY --from=direnv /tmp/direnv /usr/local/bin/direnv
COPY --from=op /tmp/op /usr/local/bin/op
COPY --from=kubectl /tmp/kubectl /usr/local/bin/kubectl
COPY --from=sops /tmp/sops /usr/local/bin/sops
COPY --from=drone /tmp/drone /usr/local/bin/drone
COPY --from=kubectx /tmp/kubectx /usr/local/bin/kctx
COPY --from=kubens /tmp/kubens /usr/local/bin/kns
COPY --from=hadolint /tmp/hadolint /usr/local/bin/hadolint

{{ $githubLast := index ($github | keys | reverse) 0 }}
ENV GITHUB_VERSIONS='{ \
  {{ range $p, $v := $github -}}
    "{{ $p }}": "{{ $v }}"
    {{- if ne $p $githubLast }},{{ end }} \
  {{ end -}}
}'

{{ $pypiLast := index (.config.tools.pip | keys | reverse) 0 }}
ENV PIP_VERSIONS='{ \
  {{ range $p, $v := .config.tools.pip -}}
    "{{ $p }}": "{{ $v }}"
    {{- if ne $p $pypiLast }},{{ end }} \
  {{ end -}}
}'

RUN adduser --home /home/user --shell /bin/bash --uid 1000 --disabled-password user

RUN kubectl completion bash > /etc/bash_completion.d/kubectl \
    && curl -fsL "https://raw.githubusercontent.com/ahmetb/kubectx/v{{ $kubectx }}/completion/kubectx.bash" -o /etc/bash_completion.d/kubectx \
    && curl -fsL "https://raw.githubusercontent.com/ahmetb/kubectx/v{{ $kubectx }}/completion/kubens.bash" -o /etc/bash_completion.d/kubens \
    && just --completions bash > /etc/bash_completion.d/just \
    && echo 'complete -C /usr/local/bin/terraform terraform' > /etc/bash_completion.d/terraform \
    && echo 'complete -C /usr/local/bin/aws_completer aws' > /etc/bash_completion.d/aws

COPY .meta/tmpl/.bashrc /home/user/.bashrc

{{- if $usesGolang }}
ENV CGO_ENABLED=0
{{- end }}
ARG workdir="/workspace"

ENV PATH="$workdir/.meta/bin:${PATH}"
ENV DIRENV_CONFIG="$workdir/.meta/direnv"
ENV STARSHIP_CONFIG="$workdir/.meta/starship/config.toml"

# RUN apk add perl

ENTRYPOINT []
